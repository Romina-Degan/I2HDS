--- 
title: "Analysis of Temporal Trends in Cancer Registry Data in NHS Scotland "
output: 
  pdf_document:
    toc: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```


# Introduction
## 1.1 Background
Understanding trends within a countries cancer registry data provided an essential understanding for health budget allocation and informed public health polices,
targeted at reducing the incidence of certain cancers. Cancer diagnoses places significant strain on not only a patients life, but on the health care budget allocated. 
This form of stress on an economies healthcare budget is known as the cancer burden. The larger the cancer burden the harder the economy must work to meet the growing 
demands placed on the healthcare system to provide the patients with the intensive care required. To illustrate this problem we can examine how  
, Europe currently has the highest health expenditure
on cancer treatment also has the highest rate of deaths in a working age (30-69) due to cancer. Despite increased funding, quality healthcare and developing research into improving 
cancer care, providing the correct care in a timely manner that ensures cancer is caught earlier to prevent increased costs on a health care system still proves an issue. This is 
where maintaining and updating health statistics is important to inform policy makers on the changing needs amid rising cases. 


# Methods
## Data Loading/Cleansing
First the relevant library packages are installed, there are som typical boilerplate packages. Of note to this paticular report, are the packages:

- Lemon - provides functionalities for geom_pointline
- kableExtra - provides functionlities to make a table in R Markdown
- Zoo - provides mathematical functions
- ggrepel - provides functionalities to ensure that text labels dont overalp on graphs

### Load in Specific Packages
```{r Load Libraries}
suppressWarnings({
library(readr)
library(tidyr)
library(dplyr)
library(here)
library(lemon)
library(kableExtra)
library(ggplot2)
library(data.table)

library(zoo)
library(ggrepel)
})
```

Once all the relevant libraries are loaded in, the data is read in from a local directory and saved into a dataframe. In this case 
the dataframe that will be used for all data manipulation of the entire cancer registry data will be named *cancerReg* 

### Load in the data 
```{r Read in the Data}
# Load in data
cancerReg <- read.csv("C:\\Users\\romin\\ToyRepo\\Models\\cancerReg.csv")

# Split the data, so structure can be seen better
cancerRegTable1 <- cancerReg[c(1,2,3,4,5,8)]
cancerRegTable2 <- cancerReg[c(6, 9, 10, 11)]

kable(head(cancerRegTable1))
#Continuation of table 1, too many columns to display in one table
kable(head(cancerRegTable2))
```

\
\
\
\
\
Not all the data provided in the initial data frame is required for further analysis and this line of code depicts the values in which will not be needed.
These values have been removed to make the data cleaner and easier to manipulate. A notable exclusion is the "numerator" column. This column is the 
raw value of the amount of people registered under that specific health board in the cancer registry. This value could not be used as a reliable indicator of  
the rate of patients in the cancer registry by a specific health board, due to its lack of standardisation.

Standardisation is essential when looking at larger population data, especially with an aging population such as Scotland's. Certain disease such as cancers
are more prevalent in an aging population as seen with (insert reference). This is a significant factor in this study as Scotland is made up of several rural areas,
in which their age distribution is significantly higher towards an elderly population. Specifically, between the more rural health boards such as NHS Orkney, NHS Ayrshire compares 
against more urban health boards such as NHS Greater Glasgow and Clyde and NHS Grampian. The biggest gap in age different is between Glasgow City and Dumfries and Galloway 
with a 14% to 27% difference respectively. Hence the importance of standardising the numerator value across the health boards, into a variable such as the measure column. 

### Remove Uncessary Data for Analysis
```{r Remove Columns}
cancerReg <- cancerReg %>% select(
    -period, -area_type, -type_definition, -indicator,
    -upper_confidence_interval, -lower_confidence_interval, -numerator
)
```

## Visual Representation of All Values in Cancer Registry Data
To understand how to best analyse the data, we first require an understanding of what the data represents. Each health board every year submitted a raw value in
the form of the numerator and the measure was then calculated against an age-sex standardisation method. After the data was adjusted, the differences in measure values 
among health boards were minimal, therefore there was a large amount of health boards falling into the same value.This caused a major issue with overplotting 
across different health boards. To try and overcome the issue of overplotting, a variety of visual graphs were tested. Such as density plots, heatmaps and stacked area charts, 
but they all proved too limited in showing the drastic jumps some health boards exhibited in certain time frames.

This portion of the assignment took the longest due to the difficulty of clearly mapping all 14 health boards over an extended period. 
Especially when there are such drastic changes in the measure, often these sharp changes in the measure value were lost in favour of generalising the data.
Therefore, the decision was made to use a scatter and line plot with varying functions designed to smoothen the lines between certain points where they seemingly overlap consistently. 

### Display All Data Points
```{r Graph Of Cancer Reg Data, echo = FALSE, fig.height = 20, fig.width = 25}
ggplot(data = cancerReg, aes(x = year, y = measure, col = area_name)) +
    geom_smooth(method = "loess", se = FALSE) +
    theme(

        legend.legend.box.spacing = unit(5.0,"cm"),
        legend.title = element_text(size=25),
        legend.text=element_text(size=30),
        legend.key.size = unit(2.0,"cm"),
        axis.text.x = element_text(size = 30),
        axis.text.y = element_text(size = 30), 
        axis.title = element_text(size = 40)
    )
```

The function *geom_smooth()* was used to account for the overplotting that occurred for the majority of the health boards in their respective time periods.
This function was particularly useful as it creates smoother transition lines between the physical dots representing the measure value across the years.
For the overall simplicity of the graph, the physical dots representing the data have been omitted, to ensure a clear overview of the data.

The data itself shows clear jumps between measure values between the health boards. To better understand the scale by which the measure values differ, 
an overall mean will be calculated for all values, while a cummulative moving average will be used to calculate the avergae of a specific health board.The aim is to 
quantify how a health board's cancer registry data differs from the overall average from 2003-2020. To analyse this relationship, the group moving average is 
calculated against an individual health board. In calculating this, we can numerically evaluate how the values have changed. 
While also investigating if a particular year showed an increase/decrease of patients in the cancer registry. 

## Calculate Overall and Moving Average for All Health Boards

### Find Average of All Measures by Year
```{r Average of All HealthBoards}
# Total Average across all health boards, grouped by the year
avgYearly <- cancerReg %>%
    group_by(year) %>%
    #Add a row showing the average number for the measure from all healthboards in a year
    mutate(AvgYear = mean(measure, na.rm = TRUE)) %>%
    select(-area_name, -measure, -area_code)
```

Since this report focuses on time series data, it would be appropriate to use time series methods to analyse the effects over the years accurately. 
Given the vast amount of historical data provided, it was important to consider how to incorporate the historical data into the analysis.
While most moving average models place emphasis and weightings on more recent data points, the cumulative moving average considers 
most historical data and provides the means of examining long term trends for patients within the cancer registry.

For the purposes of this report, we aim to explore fluctuations in registry data over the years, particularly
how the pandemic has impacted the cancer registry. We are interested in observing the increase/decrease in 
cancer trends to then explore if the pandemic did cause an effect on registry data, or if there were underlying trends
in previous years that have exacerbated the status quo. Therefore, the decision was made to use the cumulative average, to maintain 
the weighting that historical data would have on the overall value, so that a clearer distinction could be made on each year’s trend in cancer registry data. 



### Calculate Moving Average for Each Health Board
```{r Calculate Moving Average For Individual Health Boards}
# Calculate a cummulate moving average for individual healthboards
movingAvg <- cancerReg %>%
    group_by(area_name) %>%
    arrange(year) %>%
    mutate(MA = cumsum(measure) / row_number())

```



### Find Last Data Points for Data
```{r Return Last Data Points in Moving Average}
#Used for asethetic purposes only
#Code used to assign easier to read labels on graph 
finalValues <- movingAvg %>%
    group_by(area_name) %>%
    summarise(
        lastMA = dplyr::last(MA),
        lastYear=dplyr::last(year)
    )
```




### Display Summary of All Data
```{r Graph of Calculated Averages}
    options(repr.plot.width = 60, repr.plot.height =5) 
    ggplot(data = cancerReg, aes(x = year)) +
        geom_pointline(data = avgYearly, aes(y = AvgYear)) +
        geom_line(data = movingAvg, aes(y = MA, col = area_name)) +
        geom_text_repel(
            data = finalValues, aes(
                x = lastYear,
                y = lastMA,
                label = area_name,
                color = area_name
            ),
            size = 2.5,
            fontface = "bold",
            nudge_x = 5.6,
            direction = "y",
            hjust = 0.7,
            segment.linetype = 2,
            segment.size = 0.5,
            segment.curvature = 0,
            max.overlaps = Inf
        ) +

        theme(legend.position = "none", plot.margin = margin(2,2,2,2))

```

The overall average is calculated and plotted as a scatter plot over a line plot of the individual health board averages. The lines that were previously plotted
on the overview of the data have been smoothed to show the uptick in trends over time. Notably, there are few health boards that have consistently 
remained within the overall average, most of these are contained within the middle of the labels. As the labels of the graph move further out, we see stronger variations
in the measure value over time. Specifically, NHS Western Isles, NHS Orkney and NHS Shetland. These health boards consistently have shown varying levels
of fluctuation over the years. Without using the cumulative summation to calculate these averages, their historical data would have been lost. 

The moving average itself saw a slight uptick in cases during 2006-2008 and the cases yo-yoed up and down for the next 7 years until there was a sharp decline. 
This decline shows that during 2019, across all health boards the measure of patients in the cancer registry fell. To quantify this value we can calculate, the differences 
between the cumulative moving average and the overall average. The difference provided would show the rise (positive difference) or fall (negative difference) in patients
in the cancer registry, against the national average. Providing a clear indicator of trends over time, to see if the pandemic attributed to a change in cancer registry data, or 
if there was already a pattern of change before the pandemic.

## Quantify Differences Between the Averages

### Calculate Differences Function
```{r Calculate Current Point Against Moving Average}
    #Declare data frame to hold percentage values
    sigPercent <- data.frame(
        area_name = character(),
        year = integer(),
        percentNum = numeric(),
        stringsAsFactors = FALSE
    )
    boardAvg <- function(currBoard, currVal, currYear) {
        #Retrive current average for a specific year 
        currAvgYear <- filter(movingAvg, area_name == currBoard & year == currYear) %>% select(MA)
        numCurrAvgYear <- gsub("[^0-9.]", "", currAvgYear$MA)
        numCurrAvgYear <- as.numeric(numCurrAvgYear)
        #Calculate difference
        diffVal <- currVal - numCurrAvgYear
        percentVal <- ((diffVal / numCurrAvgYear) * 100)
        # Defined a threshold, where the difference percentage would be of interest
        if (percentVal >= 3 || percentVal <= -3) {
            sigPercent <- sigPercent %>% add_row(
                area_name = currBoard,
                year = currYear, 
                percentNum = round(percentVal, 2)
            )
        }
        return(sigPercent)

        
    }

```


While the moving average does not provide a direct estimation of the predicted values, it still serves as an indicator of what the value would have looked like in that time frame. 
A large deviation from that number means there was a change in the previous trend of data. To investigate such a change, we can calculate the difference in the value. Since 
the cumulative summation considered historical data, it can provide an estimation of how different that value is from the overall trend. In this case the trend is the overall 
average. It would be typical to see the value of the measure fluctuate slightly over time and therefore this difference would not be considered as a cause for interest.

A value had to be determined to capture meaningful changes in the data. The difference was expressed as a percentage, with 100% indicating
that the current point difference matched the average cases for that year, and 0% indicated no deviation from the point. Looking at the graph, meaningful
deviations meant any case that was ± 30 cases, this translates to a 3% change from the overall average value. 3% was used as the threshold, any health board for a specific year that
encountered a change of at least 3% of the overall average was saved into another data frame, to have the contents further analysed.


### Calculate Differences
```{r Calculate Differences from Current Point to Moving Average}

    healthBoards <- unique(cancerReg$area_name)
    totalYears <- unique(cancerReg$year)
    for (currBoard in healthBoards) {
        for (currYear in totalYears) {
            
            currVal <- subset(cancerReg, year == currYear & area_name == currBoard)
            currVal <- select(currVal, -area_code, -area_name, -year)
            currVal <- as.numeric(currVal)
            #Call difference function
            sigPercent <- boardAvg(currBoard, currVal, currYear)
        }
    }
    sigPercent <- sigPercent %>% arrange(desc(year))

   

``` 

##Disp

```{r Create Table of Results}

sigPercentWide <- sigPercent %>% pivot_wider(
    names_from = year,
    values_from = percentNum
)

sigPercentWide <- sigPercentWide %>% replace(is.na(.), 0)

# Add reference to statology
sigPercentTotal <- sigPercentWide %>%
    bind_rows(summarise(
        ., across(where(is.numeric), sum),
        across(where(is.character), ~"Total")
    ))

kable(sigPercentTotal, format = "latex", booktabs = TRUE, longtable = TRUE) %>%
    kable_styling(latex_options = c("striped", "hold_position")) %>%
    row_spec(0, bold = TRUE) %>%
    column_spec(1, "2cm") %>%
    
    row_spec(15, bold = TRUE) %>%
    kableExtra::landscape()

``` 

In line with the previous graph of the data points, we see that the drop in the graph was between 2019 and 2020. During those time periods 9/14 health boards saw a decrease in 
the overall number of patients in their respective cancer registries. It’s important to note at this point that the data collected come from 3-year aggregates. Any data provided from 
a specific year also includes data from the previous years. Therefore, the 2019 data is part of a 3-year aggregate containig data from 2018-2020. This form of collecting data as an aggregate 
was unclear. In the definition and dictionary of the data provided on the PHS website, it states that to accurately represent the true value of a year’s cancer registry data they require the next 
years data. This purpose was unclear. In light of this information, we can assume that the data from 2019 and 2020 come from a time during the pandemic and further analyse what the 
percentage changes mean for each of the health boards. 

The pandemic showed a clear change amongst all health boards, in addition to another year of interest in 2016 that say a total of 20% cut in cancer registry data. 2016 was a notable year 
for Scotlands economy and caused a shift in Scotlands work force, this change will be further discussed in the Results section.

There seems to be a consistent number of health boards that contribute to these changes, especially NHS Western Isles, NHS Orkney and NHS Shetland. These 
health boards experienced a deviation almost every year, this doesn’t necessarily indicate a worsening state, as lower cancer rates will also be flagged as a change from the normal. If a 
specific health board continuously has changes from the average in a negative direction it could indicate a healthier population.  
